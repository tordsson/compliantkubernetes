
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Compliant Kubernetes is a Kubernetes distribution that reduces the burden for complying with Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001.">
      
      
      
        <meta name="author" content="Elastisys AB">
      
      
        <link rel="canonical" href="https://compliantkubernetes.io/operator-manual/safespring/">
      
      <link rel="icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>On Safespring - Compliant Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
    
    
    
    
<!-- Matomo -->
<script>var _paq = window._paq = window._paq || [];
_paq.push(['disableCookies']);
_paq.push(['trackAllContentImpressions']);_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);_paq.push(['alwaysUseSendBeacon']);_paq.push(['setTrackerUrl', "\/\/elastisys.com\/wp-content\/plugins\/matomo\/app\/matomo.php"]);_paq.push(['setSiteId', '2']);var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
g.type='text/javascript'; g.async=true; g.src="\/\/elastisys.com\/wp-content\/uploads\/matomo\/matomo.js"; s.parentNode.insertBefore(g,s);
</script>
<!-- End Matomo Code -->

    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#compliant-kubernetes-deployment-on-safespring" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Compliant Kubernetes" class="md-header__button md-logo" aria-label="Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Compliant Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              On Safespring
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Compliant Kubernetes" class="md-nav__button md-logo" aria-label="Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Compliant Kubernetes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../compliance/" class="md-nav__link">
        Compliance Basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          User Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/setup/" class="md-nav__link">
        Set up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/registry/" class="md-nav__link">
        Container registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/kubernetes-api/" class="md-nav__link">
        Kubernetes API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/logs/" class="md-nav__link">
        Logs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/alerts/" class="md-nav__link">
        Alerts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/backup/" class="md-nav__link">
        Backups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/ci-cd/" class="md-nav__link">
        CI/CD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/safeguards/" class="md-nav__link">
        Safeguards
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/demarcation/" class="md-nav__link">
        Can I?
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          CISO Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CISO Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          CISO Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/backup/" class="md-nav__link">
        Backup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/cryptography/" class="md-nav__link">
        Cryptography
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/intrusion-detection/" class="md-nav__link">
        Intrusion Detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/policy-as-code/" class="md-nav__link">
        Policy-as-Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/network-security/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/kubernetes-status/" class="md-nav__link">
        Kubernetes Status
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/vulnerability/" class="md-nav__link">
        Vulnerability Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/log-review/" class="md-nav__link">
        Log Review
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Administrator Manual
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Administrator Manual" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Administrator Manual
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6_3">
          Creating/Destroying/Upgrading a Cluster
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Creating/Destroying/Upgrading a Cluster" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Creating/Destroying/Upgrading a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aws/" class="md-nav__link">
        On AWS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        On Azure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../exoscale/" class="md-nav__link">
        On Exoscale
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gcp/" class="md-nav__link">
        On GCP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openstack/" class="md-nav__link">
        On Openstack
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          On Safespring
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        On Safespring
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialize-configuration-folder" class="md-nav__link">
    Initialize configuration folder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure setup using Terraform
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-kubernetes-using-kubespray" class="md-nav__link">
    Install Kubernetes using Kubespray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-the-infrastructure" class="md-nav__link">
    Remove the infrastructure
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ovh-managed-kubernetes/" class="md-nav__link">
        On OVH Managed Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../eksd/" class="md-nav__link">
        On EKS-D
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../clean-up/" class="md-nav__link">
        Remove Compliant Kubernetes Apps
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../qa/" class="md-nav__link">
        QA
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_5">
          Configuring a Cluster
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Configuring a Cluster" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          Configuring a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-sizing/" class="md-nav__link">
        Sizing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ingress/" class="md-nav__link">
        Ingress
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../access-control/" class="md-nav__link">
        Access Control
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../user-alerts/" class="md-nav__link">
        User Alerts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../disaster-recovery/" class="md-nav__link">
        Disaster Recovery
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../break-glass/" class="md-nav__link">
        Breaking the Glass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../credentials/" class="md-nav__link">
        Use of Credentials
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Contributor Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contributor Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Contributor Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contributor-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        Architectural Decision Log
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../tech-radar/" class="md-nav__link">
        Tech Radar
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../vocabulary/" class="md-nav__link">
        Vocabulary
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        Release Notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/" class="md-nav__link">
        Support ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/blog/" class="md-nav__link">
        Blog ⧉
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialize-configuration-folder" class="md-nav__link">
    Initialize configuration folder
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure setup using Terraform
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-kubernetes-using-kubespray" class="md-nav__link">
    Install Kubernetes using Kubespray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remove-the-infrastructure" class="md-nav__link">
    Remove the infrastructure
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/elastisys/compliantkubernetes/edit/main/docs/operator-manual/safespring.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <div class="admonition bug">
<p class="admonition-title">This page is out of date</p>
<p>We are currently working on internal documentation to streamline
Compliant Kubernetes onboarding for selected cloud providers. Until
those documents are ready, and until we have capacity to make parts of
that documentation public, this page is out-of-date.</p>
<p>Nevertheless, parts of it are useful. Use at your own risk and don't expect things to work smoothly.</p>
</div>
<!--out-of-date-end-->

<h1 id="compliant-kubernetes-deployment-on-safespring">Compliant Kubernetes Deployment on Safespring<a class="headerlink" href="#compliant-kubernetes-deployment-on-safespring" title="Permanent link">&para;</a></h1>
<p>This document contains instructions on how to set up a Compliant Kubernetes environment (consisting of a service cluster and one or more workload clusters) on Safespring.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide is written for compliantkubernetes-apps <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/v0.13.0">v0.13.0</a></p>
</div>
<p>TODO: The document is split into two parts:</p>
<ul>
<li>
<p>Cluster setup (setting up infrastructure and the Kubernetes clusters).
  We will be using the <a href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack">Terraform module for Openstack that can be found in the Kubespray repository</a>.
  Please refer to it if you need more details about this part of the setup.</p>
</li>
<li>
<p>Apps setup (including information about limitations)</p>
</li>
</ul>
<p>Before starting, make sure you have <a href="../getting-started/">all necessary tools</a>. In addition to these general tools, you will also need:</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack#openstack-access-and-credentials">Openstack credentials</a> (either using <code>openrc</code> or the <code>clouds.yaml</code> configuration file) for setting up the infrastructure.</p>
</li>
<li>
<p>For Safespring, you can get these by logging into the Safespring Openstack dashboard and download either the <code>clouds.yaml</code> or <code>OpenRC</code> file from the API Access page.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although recommended OpenStack authentication method is <code>clouds.yaml</code> it is more convenient to use the <code>openrc</code> method with compliant kubernetes as it works both with kubespray and terraform. If you are using the <code>clouds.yaml</code> method, at the moment, kubespray will still expect you to set a few environment variables.</p>
</div>
<h2 id="initialize-configuration-folder">Initialize configuration folder<a class="headerlink" href="#initialize-configuration-folder" title="Permanent link">&para;</a></h2>
<p>Choose names for your service cluster and workload cluster(s):</p>
<div class="highlight"><pre><span></span><code><span class="nv">SERVICE_CLUSTER</span><span class="o">=</span><span class="s2">&quot;testsc&quot;</span>
<span class="nv">WORKLOAD_CLUSTERS</span><span class="o">=(</span> <span class="s2">&quot;testwc0&quot;</span> <span class="s2">&quot;testwc1&quot;</span> <span class="o">)</span>
</code></pre></div>
<p>Start by initializing a Compliant Kubernetes environment using Compliant Kubernetes Kubespray.
All of this is done from the root of the <code>compliantkubernetes-kubespray</code> repository.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/&lt;environment-name&gt;
<span class="nb">export</span> <span class="nv">SOPS_FP</span><span class="o">=</span>&lt;PGP-fingerprint&gt;

<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  ./bin/ck8s-kubespray init <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">&quot;</span> openstack <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SOPS_FP</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>
</code></pre></div>
<h2 id="infrastructure-setup-using-terraform">Infrastructure setup using Terraform<a class="headerlink" href="#infrastructure-setup-using-terraform" title="Permanent link">&para;</a></h2>
<p>Configure Terraform by creating a <code>cluster.tfvars</code> file for each cluster.
The available options can be seen in <code>kubespray/contrib/terraform/openstack/variables.tf</code>.
There is a sample file that can be copied to get something to start from.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
  cp kubespray/contrib/terraform/openstack/sample-inventory/cluster.tfvars <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/cluster.tfvars&quot;</span>
<span class="k">done</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You really <em>must</em> edit the values in these files.
There is no way to set sane defaults for what flavor to use, what availability zones or networks are available across providers.
In the section below some guidance and samples are provided but remember that they might be useless to you depending on your needs and setup.</p>
</div>
<h3 id="infrastructure-guidance">Infrastructure guidance<a class="headerlink" href="#infrastructure-guidance" title="Permanent link">&para;</a></h3>
<p>We recommend you to have at least three worker nodes with 4 cores and 8 GB memory each, and we recommend you to have at least 2 cores and 4 GB for your control plane nodes.</p>
<p>Below is example <code>cluster.tfvars</code> for a few select openstack providers.
The examples are copy-pastable, but you might want to change <code>cluster_name</code> and <code>network_name</code> (if neutron is used!).</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Safespring sto1 with public IPs assigned to VMs (no floating IP)</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code># your Kubernetes cluster name here
cluster_name = &quot;your-cluster-name&quot;

# image to use for bastion, masters, standalone etcd instances, and nodes
image = &quot;ubuntu-20.04&quot;

# 0|1 bastion nodes
number_of_bastions = 0

use_neutron = 0

# standalone etcds
number_of_etcd = 0

# masters
number_of_k8s_masters = 0
number_of_k8s_masters_no_etcd = 0
number_of_k8s_masters_no_floating_ip = 1
number_of_k8s_masters_no_floating_ip_no_etcd = 0
flavor_k8s_master = &quot;8a707999-0bce-4f2f-8243-b4253ba7c473&quot;

# nodes
number_of_k8s_nodes = 0
number_of_k8s_nodes_no_floating_ip = 3
flavor_k8s_node = &quot;5b40af67-9d11-45ed-a44f-e876766160a5&quot;

# networking
# ssh access to nodes
k8s_allowed_remote_ips = [&quot;0.0.0.0/0&quot;]
worker_allowed_ports = [
  { # Node ports
    &quot;protocol&quot;         = &quot;tcp&quot;
    &quot;port_range_min&quot;   = 30000
    &quot;port_range_max&quot;   = 32767
    &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
  },
  { # HTTP
    &quot;protocol&quot;         = &quot;tcp&quot;
    &quot;port_range_min&quot;   = 80
    &quot;port_range_max&quot;   = 80
    &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
  },
  { # HTTPS
    &quot;protocol&quot;         = &quot;tcp&quot;
    &quot;port_range_min&quot;   = 443
    &quot;port_range_max&quot;   = 443
    &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
  }
]
external_net = &quot;b19680b3-c00e-40f0-ad77-4448e81ae226&quot;
use_access_ip = 1
network_name = &quot;public&quot;

use_server_groups = true # Comment this out if you don&#39;t mind that the VMs are schedules on different physical machines
                         # Also, comment this out if you run into problems on Safespring because of shortage of physical machines
</code></pre></div>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Safespring sto1 with private IPs and floating IPs assigned to VMs</label><div class="tabbed-content"></div>
</div>
<p>For this to work, make sure that you can create networks and floating IPs on Safespring.</p>
<div class="highlight"><pre><span></span><code>    ``` hcl
    # your Kubernetes cluster name here
    cluster_name = &quot;your-cluster-name&quot;

    # image to use for bastion, masters, standalone etcd instances, and nodes
    image = &quot;ubuntu-20.04&quot;

    # 0|1 bastion nodes
    number_of_bastions = 0

    use_neutron = 0

    # standalone etcds
    number_of_etcd = 0

    # masters
    number_of_k8s_masters = 1
    number_of_k8s_masters_no_etcd = 0
    number_of_k8s_masters_no_floating_ip = 0
    number_of_k8s_masters_no_floating_ip_no_etcd = 0
    flavor_k8s_master = &quot;8a707999-0bce-4f2f-8243-b4253ba7c473&quot;

    # nodes
    number_of_k8s_nodes = 3
    number_of_k8s_nodes_no_floating_ip = 0
    flavor_k8s_node = &quot;5b40af67-9d11-45ed-a44f-e876766160a5&quot;

    # networking
    # ssh access to nodes
    k8s_allowed_remote_ips = [&quot;0.0.0.0/0&quot;]
    worker_allowed_ports = [
      { # Node ports
        &quot;protocol&quot;         = &quot;tcp&quot;
        &quot;port_range_min&quot;   = 30000
        &quot;port_range_max&quot;   = 32767
        &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
      },
      { # HTTP
        &quot;protocol&quot;         = &quot;tcp&quot;
        &quot;port_range_min&quot;   = 80
        &quot;port_range_max&quot;   = 80
        &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
      },
      { # HTTPS
        &quot;protocol&quot;         = &quot;tcp&quot;
        &quot;port_range_min&quot;   = 443
        &quot;port_range_max&quot;   = 443
        &quot;remote_ip_prefix&quot; = &quot;0.0.0.0/0&quot;
      }
    ]
    external_net = &quot;b19680b3-c00e-40f0-ad77-4448e81ae226&quot;
    use_access_ip = 1
    network_name = &quot;private&quot; # Change this if you would like a new network to be created

    use_server_groups = true # Comment this out if you don&#39;t mind that the VMs are schedules on different physical machines
                             # Also, comment this out if you run into problems on Safespring because of shortage of physical machines
    ```
</code></pre></div>
<h3 id="expose-openstack-credentials-to-terraform">Expose Openstack credentials to Terraform<a class="headerlink" href="#expose-openstack-credentials-to-terraform" title="Permanent link">&para;</a></h3>
<p>Terraform will need access to Openstack credentials in order to create the infrastructure.
More details can be found <a href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack#openstack-access-and-credentials">here</a>.</p>
<p>We will be using the declarative option with the <code>clouds.yaml</code> file.
Since this file can contain credentials for multiple environments, we specify the name of the one we want to use in the environment variable <code>OS_CLOUD</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">OS_CLOUD</span><span class="o">=</span>&lt;name-of-openstack-cloud-environment&gt;
</code></pre></div>
<p>If you use the <code>clouds.yaml</code> file copy it in the <code>compliantkubernetes-kubespray/kubespray/contrib/terraform/openstack/</code> and edit the file to add your password <code>password: your-safespring-openstack-password</code> in the <code>auth:</code> section.</p>
<p>Alternatively, using the <code>openrc</code> file:</p>
<p><code>source /path/to/your/openrc/file</code></p>
<h3 id="initialize-and-apply-terraform">Initialize and apply Terraform<a class="headerlink" href="#initialize-and-apply-terraform" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">MODULE_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/kubespray/contrib/terraform/openstack&quot;</span>

<span class="nb">pushd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MODULE_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  terraform init
  terraform apply -var-file<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/cluster.tfvars&quot;</span> -state<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/terraform.tfstate&quot;</span>
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The above will not work well if you are using a bastion host.
This is due to <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/contrib/terraform/openstack/modules/compute/main.tf#L207">some hard coded paths</a>.
To work around it, you may link the <code>kubespray/contrib</code> folder to the correct relative path, or make sure your <code>CK8S_CONFIG_PATH</code> is already at a proper place relative to the same.</p>
</div>
<h2 id="install-kubernetes-using-kubespray">Install Kubernetes using Kubespray<a class="headerlink" href="#install-kubernetes-using-kubespray" title="Permanent link">&para;</a></h2>
<p>Before we can run Kubespray, we will need to go through the relevant variables.
Additionally we will need to expose some credentials so that Kubespray can set up cloud provider integration.</p>
<p>You will need to change at least one value: <code>kube_oidc_url</code> in <code>group_vars/k8s_cluster/ck8s-k8s_cluster.yaml</code>, normally this should be set to <code>https://dex.BASE_DOMAIN</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have <code>use_access_ip = 0</code> in <code>cluster.tfvars</code>, you should add the public ip address of the master nodes to the variable <code>supplementary_addresses_in_ssl_keys = ["&lt;master-0-ip-address&gt;",...]</code> somewhere under <code>group_vars/</code>.</p>
</div>
<p>For cloud provider integration, you have a few options <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/openstack.md#the-external-cloud-provider">as described here</a>.
We will be going with the external cloud provider and simply source the Openstack credentials.
See below for how to modify the variables that need to be modified.</p>
<h3 id="setting-up-kubespray-variables">Setting up Kubespray variables<a class="headerlink" href="#setting-up-kubespray-variables" title="Permanent link">&para;</a></h3>
<p>In <code>${CK8S_CONFIG_PATH}/$CLUSTER-config/group_vars/k8s_cluster/ck8s-k8s-cluster-openstack.yaml</code>, the default variables should look like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">etcd_kubeadm_enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">cloud_provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">external</span>
<span class="nt">external_cloud_provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openstack</span>
<span class="nt">calico_mtu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1480</span>

<span class="nt">external_openstack_cloud_controller_extra_args</span><span class="p">:</span>
  <span class="c1"># Must be different for every cluster in the same openstack project</span>
  <span class="nt">cluster-name</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>

<span class="nt">cinder_csi_enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">persistent_volumes_enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">expand_persistent_volumes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">openstack_blockstorage_ignore_volume_az</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">storage_classes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cinder-csi</span>
    <span class="nt">is_default</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">parameters</span><span class="p">:</span>
      <span class="nt">allowVolumeExpansion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">availability</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nova</span>
</code></pre></div>
<p><code>cluster-name</code> should be set to a name that is unique in the Openstack project you're deploying your clusters in. If you don't have any other clusters in the project, just make sure that the service cluster and workload clusters have different names.</p>
<p>Cinder CSI is enabled by default along with the configuration options to enable persistent volumes and the expansion of these volumes. It is also set to ignore the volume availability zone to allow volumes to attach to nodes in different or mismatching zones. The default works well with both CityCloud and SafeSpring.</p>
<p>If you want to set up LBaaS in your cluster, you can add the following config:</p>
<div class="highlight"><pre><span></span><code><span class="nt">external_openstack_lbaas_create_monitor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">external_openstack_lbaas_monitor_delay</span><span class="p">:</span> <span class="s">&quot;1m&quot;</span>
<span class="nt">external_openstack_lbaas_monitor_timeout</span><span class="p">:</span> <span class="s">&quot;30s&quot;</span>
<span class="nt">external_openstack_lbaas_monitor_max_retries</span><span class="p">:</span> <span class="s">&quot;3&quot;</span>
<span class="nt">external_openstack_lbaas_provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">octavia</span>
<span class="nt">external_openstack_lbaas_use_octavia</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="c1"># external_openstack_lbaas_network_id: &quot;Neutron network ID to create LBaaS VIP&quot;</span>
<span class="nt">external_openstack_lbaas_subnet_id</span><span class="p">:</span> <span class="s">&quot;Neutron</span><span class="nv"> </span><span class="s">subnet</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">create</span><span class="nv"> </span><span class="s">LBaaS</span><span class="nv"> </span><span class="s">VIP&quot;</span>
<span class="nt">external_openstack_lbaas_floating_network_id</span><span class="p">:</span> <span class="s">&quot;Neutron</span><span class="nv"> </span><span class="s">network</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">get</span><span class="nv"> </span><span class="s">floating</span><span class="nv"> </span><span class="s">IP</span><span class="nv"> </span><span class="s">from&quot;</span>
<span class="c1"># external_openstack_lbaas_floating_subnet_id: &quot;Neutron subnet ID to get floating IP from&quot;</span>
<span class="nt">external_openstack_lbaas_method</span><span class="p">:</span> <span class="s">&quot;ROUND_ROBIN&quot;</span>
<span class="nt">external_openstack_lbaas_manage_security_groups</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">external_openstack_lbaas_internal_lb</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<p>The <code>network_id</code> and <code>subnet_id</code> variables need to be set by you, depending on whether or not you used floating IP. <code>network_id</code> should match the <code>external_net</code> variable in your Terraform variables, whereas the <code>subnet_id</code> should match the subnet ID that Terraform outputs after it is applied.</p>
<p>Additionally, when you later set up <code>compliantkubernetes-apps</code> in your cluster, you should set <code>ingressNginx.controller.service.enabled</code> to <code>true</code> and <code>ingressNginx.controller.service.type</code> to <code>LoadBalancer</code> in both your <code>sc-config.yaml</code> and <code>wc-config.yaml</code>. Use the IP of the <code>ingress-nginx-controller</code> service in your cluster when you set up your DNS.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point if the cluster is running on Safespring and you are using <code>kubespray v2.17.0+</code> it is possible to create an application credential.
Which will give the cluster its own set of credentials instead of using your own.</p>
<p>To create a set of credentials use the following command:
<code>openstack application credential create &lt;name&gt;</code></p>
<p>And set the following environment variables</p>
<div class="highlight"><pre><span></span><code><span class="go">export OS_APPLICATION_CREDENTIAL_NAME: &lt;name&gt;</span>
<span class="go">export OS_APPLICATION_CREDENTIAL_ID: &lt;project_id&gt;</span>
<span class="go">export OS_APPLICATION_CREDENTIAL_SECRET: &lt;secret&gt;</span>
</code></pre></div>
</div>
<h3 id="run-kubespray">Run Kubespray<a class="headerlink" href="#run-kubespray" title="Permanent link">&para;</a></h3>
<p>Copy the script for generating dynamic ansible inventories:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  cp kubespray/contrib/terraform/terraform.py <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/inventory.ini&quot;</span>
  chmod +x <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/inventory.ini&quot;</span>
<span class="k">done</span>
</code></pre></div>
<p>Now it is time to run the Kubespray playbook!</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  ./bin/ck8s-kubespray apply <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>
</code></pre></div>
<h3 id="test-access-to-the-kubernetes-api">Test access to the Kubernetes API<a class="headerlink" href="#test-access-to-the-kubernetes-api" title="Permanent link">&para;</a></h3>
<p>You should now have an encrypted kubeconfig file for each cluster under <code>$CK8S_CONFIG_PATH/.state</code>.
Check that they work like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  sops exec-file <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">.yaml&quot;</span> <span class="s2">&quot;kubectl --kubeconfig {} cluster-info&quot;</span>
<span class="k">done</span>
</code></pre></div>
<p>The output should be similar to this.</p>
<div class="highlight"><pre><span></span><code>Kubernetes control plane is running at https://&lt;public-ip&gt;:6443

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
Kubernetes control plane is running at https://&lt;public-ip&gt;:6443

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre></div>
<h3 id="create-the-dns-records">Create the DNS Records<a class="headerlink" href="#create-the-dns-records" title="Permanent link">&para;</a></h3>
<p>You will need to setup a number of DNS entries for traffic to be routed correctly.
Determine the public IP of one or more of the nodes in the service cluster.
Then point these domains to the services.</p>
<p>Since Safespring does not have a domain name service, use alternatives such as AWS Route53.</p>
<h2 id="deploying-compliant-kubernetes-apps">Deploying Compliant Kubernetes Apps<a class="headerlink" href="#deploying-compliant-kubernetes-apps" title="Permanent link">&para;</a></h2>
<p>Now that the Kubernetes clusters are up and running, we are ready to install the Compliant Kubernetes apps.</p>
<h3 id="clone-compliantkubernetes-apps-and-install-pre-requisites">Clone <code>compliantkubernetes-apps</code> and Install Pre-requisites<a class="headerlink" href="#clone-compliantkubernetes-apps-and-install-pre-requisites" title="Permanent link">&para;</a></h3>
<p>If you haven't done so already, clone the <code>compliantkubernetes-apps</code> repo and install pre-requisites.</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/elastisys/compliantkubernetes-apps.git
<span class="nb">cd</span> compliantkubernetes-apps
ansible-playbook -e <span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span> --ask-become-pass --connection <span class="nb">local</span> --inventory <span class="m">127</span>.0.0.1, get-requirements.yaml
</code></pre></div>
<h3 id="initialize-the-apps-configuration">Initialize the apps configuration<a class="headerlink" href="#initialize-the-apps-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_ENVIRONMENT_NAME</span><span class="o">=</span>my-environment-name
<span class="c1">#export CK8S_FLAVOR=[dev|prod] # defaults to dev</span>
<span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/my-cluster-path
<span class="nb">export</span> <span class="nv">CK8S_CLOUD_PROVIDER</span><span class="o">=</span><span class="c1"># [exoscale|safespring|citycloud|aws|baremetal]</span>
<span class="nb">export</span> <span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your GPG key fingerprint&gt;  <span class="c1"># retrieve with gpg --list-secret-keys</span>

./bin/ck8s init
</code></pre></div>
<p>Three files, <code>sc-config.yaml</code> and <code>wc-config.yaml</code>, and <code>secrets.yaml</code>, were generated in the <code>${CK8S_CONFIG_PATH}</code> directory.</p>
<div class="highlight"><pre><span></span><code>ls -l <span class="nv">$CK8S_CONFIG_PATH</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to generate random passwords for all services, you can run the script <code>scripts/generate-secrets.sh</code></p>
</div>
<h3 id="configure-the-apps">Configure the apps<a class="headerlink" href="#configure-the-apps" title="Permanent link">&para;</a></h3>
<p>Edit the configuration files <code>${CK8S_CONFIG_PATH}/sc-config.yaml</code>, <code>${CK8S_CONFIG_PATH}/wc-config.yaml</code> and <code>${CK8S_CONFIG_PATH}/secrets.yaml</code> and set the appropriate values for some of the configuration fields.
Note that, the latter is encrypted.</p>
<div class="highlight"><pre><span></span><code>vim <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml
vim <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/wc-config.yaml
sops <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml
</code></pre></div>
<p>The following are the minimum change you should perform:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/sc-config.yaml and ${CK8S_CONFIG_PATH}/wc-config.yaml</span>
<span class="nt">global</span><span class="p">:</span>
  <span class="nt">baseDomain</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set to $CK8S_ENVIRONMENT_NAME.$DOMAIN</span>
  <span class="nt">opsDomain</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set to ops.$CK8S_ENVIRONMENT_NAME.$DOMAIN</span>
  <span class="nt">issuer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>

<span class="nt">objectStorage</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;s3&quot;</span>
  <span class="nt">s3</span><span class="p">:</span>
    <span class="nt">region</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># Region for S3 buckets, e.g, west-1</span>
    <span class="nt">regionEndpoint</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># e.g., https://s3.us-west-1.amazonaws.com</span>

<span class="nt">storageClasses</span><span class="p">:</span>
  <span class="nt">default</span><span class="p">:</span>  <span class="l l-Scalar l-Scalar-Plain">cinder-csi</span>
  <span class="nt">nfs</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="nt">cinder</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="nt">ebs</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/sc-config.yaml (in addition to the changes above)</span>
<span class="nt">ingressNginx</span><span class="p">:</span>
    <span class="nt">controller</span><span class="p">:</span>
      <span class="nt">service</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;this-is-not-used&quot;</span>
        <span class="nt">annotations</span><span class="p">:</span> <span class="s">&quot;this-is-not-used&quot;</span>

<span class="nt">harbor</span><span class="p">:</span>
  <span class="nt">oidc</span><span class="p">:</span>
    <span class="nt">groupClaimName</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span> <span class="c1"># set to group claim name used by OIDC provider</span>

<span class="nt">issuers</span><span class="p">:</span>
  <span class="nt">letsencrypt</span><span class="p">:</span>
    <span class="nt">prod</span><span class="p">:</span>
      <span class="nt">email</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set this to an email to receive LetsEncrypt notifications</span>
    <span class="nt">staging</span><span class="p">:</span>
      <span class="nt">email</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set this to an email to receive LetsEncrypt notifications</span>
</code></pre></div>
<p>Edit ${CK8S_CONFIG_PATH}/secrets.yaml with sops</p>
<p><code>sops ${CK8S_CONFIG_PATH}/secrets.yaml</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># ${CK8S_CONFIG_PATH}/secrets.yaml</span>
<span class="nt">objectStorage</span><span class="p">:</span>
  <span class="nt">s3</span><span class="p">:</span>
    <span class="nt">accessKey</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span> <span class="c1"># set to your s3 accesskey</span>
    <span class="nt">secretKey</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span> <span class="c1"># set to your s3 secretKey</span>
</code></pre></div>
<h3 id="create-s3-buckets">Create S3 buckets<a class="headerlink" href="#create-s3-buckets" title="Permanent link">&para;</a></h3>
<p>Create object storage buckets for backups and container registry storage (if desired).</p>
<p>For this you need to obtain access keys from Safespring to be able to create S3 buckets.</p>
<div class="highlight"><pre><span></span><code>cd compliantkubernetes-apps
git checkout v0.17.0
AWS_ACCESS_KEY=set-me
AWS_ACCESS_SECRET_KEY=set-me
scripts/S3/generate-s3cfg.sh safespring ${AWS_ACCESS_KEY} ${AWS_ACCESS_SECRET_KEY} s3.sto2.safedc.net sto2 &gt; ~/.s3cfg
scripts/S3/entry.sh create
</code></pre></div>
<h3 id="test-s3">Test S3<a class="headerlink" href="#test-s3" title="Permanent link">&para;</a></h3>
<p>To ensure that you have configured S3 correctly, run the following snippet:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>
    <span class="nv">access_key</span><span class="o">=</span><span class="k">$(</span>sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml <span class="s1">&#39;yq r {} &quot;objectStorage.s3.accessKey&quot;&#39;</span><span class="k">)</span>
    <span class="nv">secret_key</span><span class="o">=</span><span class="k">$(</span>sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml <span class="s1">&#39;yq r {} &quot;objectStorage.s3.secretKey&quot;&#39;</span><span class="k">)</span>
    <span class="nv">region</span><span class="o">=</span><span class="k">$(</span>yq r <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml <span class="s1">&#39;objectStorage.s3.region&#39;</span><span class="k">)</span>
    <span class="nv">host</span><span class="o">=</span><span class="k">$(</span>yq r <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml <span class="s1">&#39;objectStorage.s3.regionEndpoint&#39;</span><span class="k">)</span>

    <span class="k">for</span> bucket <span class="k">in</span> <span class="k">$(</span>yq r <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml <span class="s1">&#39;objectStorage.buckets.*&#39;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        s3cmd --access_key<span class="o">=</span><span class="si">${</span><span class="nv">access_key</span><span class="si">}</span> --secret_key<span class="o">=</span><span class="si">${</span><span class="nv">secret_key</span><span class="si">}</span> <span class="se">\</span>
            --region<span class="o">=</span><span class="si">${</span><span class="nv">region</span><span class="si">}</span> --host<span class="o">=</span><span class="si">${</span><span class="nv">host</span><span class="si">}</span> <span class="se">\</span>
            ls s3://<span class="si">${</span><span class="nv">bucket</span><span class="si">}</span> &gt; /dev/null
        <span class="o">[</span> <span class="si">${</span><span class="p">?</span><span class="si">}</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Bucket </span><span class="si">${</span><span class="nv">bucket</span><span class="si">}</span><span class="s2"> exists!&quot;</span>
    <span class="k">done</span>
<span class="o">)</span>
</code></pre></div>
<h3 id="prepare-for-compliant-kubernetes-apps">Prepare for Compliant Kubernetes Apps<a class="headerlink" href="#prepare-for-compliant-kubernetes-apps" title="Permanent link">&para;</a></h3>
<p>To make the kubeconfig files work with Compliant Kubernetes Apps, you will need to rename or copy them, since Compliant Kubernetes Apps currently only support clusters named <code>sc</code> and <code>wc</code>.
If you have multiple workload clusters, you can make this work by setting <code>CK8S_CONFIG_PATH</code> to each <code>$CK8S_CONFIG_PATH/$CLUSTER-config</code> in turn.
I.e. <code>CK8S_CONFIG_PATH</code> will be different for compliantkubernetes-kubespray and compliantkubernetes-apps.</p>
<div class="highlight"><pre><span></span><code># In compliantkubernetes-kubespray
CK8S_CONFIG_PATH=~/.ck8s/&lt;environment-name&gt;
# In compliantkubernetes-apps (one config path per workload cluster)
CK8S_CONFIG_PATH=~/.ck8s/&lt;environment-name&gt;/&lt;prefix&gt;-config
</code></pre></div>
<p>Copy the kubeconfig files to a path that Apps can find.</p>
<p><strong>Option 1</strong> - A single workload cluster:</p>
<div class="highlight"><pre><span></span><code>cp <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_</span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="s2">.yaml&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_sc.yaml&quot;</span>
cp <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">.yaml&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_wc.yaml&quot;</span>
</code></pre></div>
<p>You can now use the same <code>CK8S_CONFIG_PATH</code> for Apps as for compliantkubernetes-kubespray.</p>
<p><strong>Option 2</strong> - A multiple workload cluster:</p>
<div class="highlight"><pre><span></span><code>mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="s2">-config/.state&quot;</span>
cp <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_</span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="s2">.yaml&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span><span class="s2">-config/.state/kube_config_sc.yaml&quot;</span>
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/.state&quot;</span>
  cp <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/.state/kube_config_</span><span class="si">${</span><span class="nv">CLUSTERS</span><span class="si">}</span><span class="s2">.yaml&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/.state/kube_config_wc.yaml&quot;</span>
<span class="k">done</span>
</code></pre></div>
<p>You will then need to set <code>CK8S_CONFIG_PATH</code> to each <code>$CLUSTER-config</code> folder in turn, in order to install Apps on the service cluster and workload clusters.</p>
<p>With this you should be ready to install Compliant Kubernetes Apps on top of the clusters.</p>
<h5 id="edit-the-storage-class-manifests">Edit the storage class manifests<a class="headerlink" href="#edit-the-storage-class-manifests" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>./bin/ck8s ops kubectl sc edit storageclass cinder-csi
./bin/ck8s ops kubectl wc edit storageclass cinder-csi
</code></pre></div>
<p>Set storageclass.kubernetes.io/is-default-class: "true"</p>
<h3 id="install-compliant-kubernetes-apps">Install Compliant Kubernetes Apps!<a class="headerlink" href="#install-compliant-kubernetes-apps" title="Permanent link">&para;</a></h3>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln -sf $CK8S_CONFIG_PATH/.state/kube_config_${SERVICE_CLUSTER}.yaml $CK8S_CONFIG_PATH/.state/kube_config_sc.yaml
./bin/ck8s apply sc  # Respond &quot;n&quot; if you get a WARN
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code>for CLUSTER in &quot;${WORKLOAD_CLUSTERS[@]}&quot;; do
    ln -sf $CK8S_CONFIG_PATH/.state/kube_config_${CLUSTER}.yaml $CK8S_CONFIG_PATH/.state/kube_config_wc.yaml
    ./bin/ck8s apply wc  # Respond &quot;n&quot; if you get a WARN
done
</code></pre></div>
<!--settling-start-->
<h3 id="settling">Settling<a class="headerlink" href="#settling" title="Permanent link">&para;</a></h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Leave sufficient time for the system to settle, e.g., request TLS certificates from LetsEncrypt, perhaps as much as 20 minutes.</p>
</div>
<p>You can check if the system settled as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces pods&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above. All Pods needs to be Running or Completed.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces issuers,clusterissuers,certificates&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above.
All resources need to have the Ready column True.</p>
<!--settling-stop-->

<!--testing-start-->
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h3>
<p>After completing the installation step you can test if the apps are properly installed and ready using the commands below.</p>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s <span class="nb">test</span> sc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
    ./bin/ck8s <span class="nb">test</span> wc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
<span class="k">done</span>
</code></pre></div>
<p>Done.
Navigate to the endpoints, for example <code>grafana.$BASE_DOMAIN</code>, <code>kibana.$BASE_DOMAIN</code>, <code>harbor.$BASE_DOMAIN</code>, etc. to discover Compliant Kubernetes's features.</p>
<!--testing-stop-->

<!--clean-apps-start-->
<h3 id="removing-compliant-kubernetes-apps-from-your-cluster">Removing Compliant Kubernetes Apps from your cluster<a class="headerlink" href="#removing-compliant-kubernetes-apps-from-your-cluster" title="Permanent link">&para;</a></h3>
<p>To remove the applications added by compliant kubernetes you can use the two scripts <code>clean-sc.sh</code> and <code>clean-wc.sh</code>, they are located here in the <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts">scripts folder</a>.</p>
<p>They perform the following actions:</p>
<ol>
<li>Delete the added helm charts</li>
<li>Delete the added namespaces</li>
<li>Delete any remaining PersistentVolumes</li>
<li>Delete the added CustomResourceDefinitions</li>
</ol>
<p>Note: if user namespaces are managed by Compliant Kubernetes apps then they will also be deleted if you clean up the workload cluster.</p>
<!--clean-apps-stop-->

<h2 id="remove-the-infrastructure">Remove the infrastructure<a class="headerlink" href="#remove-the-infrastructure" title="Permanent link">&para;</a></h2>
<p>Destroy the infrastructure using Terraform, the same way you created it:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> compliantkubernetes-kubespray/
<span class="nv">MODULE_PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/kubespray/contrib/terraform/openstack&quot;</span>

<span class="nb">pushd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MODULE_PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  terraform init
  terraform destroy -var-file<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/cluster.tfvars&quot;</span> -state<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span><span class="s2">-config/terraform.tfstate&quot;</span>
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<p>Don't forget to remove any DNS records and object storage buckets that you may have created.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../openstack/" class="md-footer__link md-footer__link--prev" aria-label="Previous: On Openstack" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              On Openstack
            </div>
          </div>
        </a>
      
      
        
        <a href="../ovh-managed-kubernetes/" class="md-footer__link md-footer__link--next" aria-label="Next: On OVH Managed Kubernetes" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              On OVH Managed Kubernetes
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright © 2020 Elastisys AB
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>